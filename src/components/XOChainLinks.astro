---
import { XO_DIGEST_BASE, XO_LEDGER_BASE, XO_VAULT_BASE } from '../consts';
import { normalizeDigestDay } from '../lib/xo_chain';

interface Props {
  vaultUrl?: string;
  ledgerDay?: string;
  digestDay?: string;
  pubDate?: Date;
  vaultVerified?: boolean;
}

const { vaultUrl, ledgerDay, digestDay, pubDate, vaultVerified = false } = Astro.props;

const digestDayNorm =
  normalizeDigestDay(digestDay) ?? (pubDate ? normalizeDigestDay(pubDate) : undefined);
const ledgerDayNorm =
  normalizeDigestDay(ledgerDay) ?? (pubDate ? normalizeDigestDay(pubDate) : undefined);

const viewerBase = XO_VAULT_BASE.replace(/\/$/, '');
const viewInVaultHref =
  vaultUrl ||
  (ledgerDayNorm ? `${viewerBase}/vault/daily/index.html#${ledgerDayNorm}` : undefined);

const digestJsonUrl = digestDayNorm
  ? `${XO_DIGEST_BASE}/vault/daily/digest.${encodeURIComponent(digestDayNorm)}.json`
  : undefined;
const digestValidateUrl = digestDayNorm
  ? `${XO_DIGEST_BASE}/vault/daily/validate/${encodeURIComponent(digestDayNorm)}`
  : undefined;
const ledgerDayUrl = ledgerDayNorm
  ? `${XO_LEDGER_BASE}/ledger/day/${ledgerDayNorm}`
  : undefined;
const ledgerMerkleUrl = ledgerDayNorm
  ? `${XO_LEDGER_BASE}/ledger/day/${ledgerDayNorm}/merkle`
  : undefined;
const ledgerPdfUrl = ledgerDayNorm
  ? `${XO_LEDGER_BASE}/ledger/day/${ledgerDayNorm}/pdf`
  : undefined;

const hasAny =
  viewInVaultHref || digestJsonUrl || ledgerDayUrl;
---

{hasAny && (
  <nav class="card" aria-label="XO chain links" style="margin-top: 1.5rem;">
    {digestDayNorm && (
      <p class="muted" style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">
        Referenced by Digest day{' '}
        <a href={`/digest/${digestDayNorm}/`}>{digestDayNorm}</a>
        {digestValidateUrl && (
          <>
            {' '}&#183;{' '}
            <a href={digestValidateUrl} target="_blank" rel="noopener noreferrer">validate</a>
          </>
        )}
      </p>
    )}
    <p class="muted" style="margin: 0 0 0.75rem 0; font-size: 0.875rem;">Canonical chain</p>
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      {viewInVaultHref && vaultVerified && (
        <span class="pill" aria-label="Vault verified" title="Verified by xo-vault proofs">Vault âœ“</span>
      )}
      {viewInVaultHref && !vaultVerified && (
        <span class="pill muted" aria-label="Vault unverified" title="Not present in xo-vault proofs yet">Vault ?</span>
      )}
      {viewInVaultHref && (
        <a class="pill" href={viewInVaultHref} target="_blank" rel="noopener noreferrer">View in Vault</a>
      )}
      {ledgerDayUrl && (
        <a class="pill" href={ledgerDayUrl} target="_blank" rel="noopener noreferrer">Ledger day</a>
      )}
      {ledgerMerkleUrl && (
        <a class="pill" href={ledgerMerkleUrl} target="_blank" rel="noopener noreferrer">Merkle proof</a>
      )}
      {ledgerPdfUrl && (
        <a class="pill" href={ledgerPdfUrl} target="_blank" rel="noopener noreferrer">PDF</a>
      )}
      {digestJsonUrl && (
        <a class="pill" href={digestJsonUrl} target="_blank" rel="noopener noreferrer">Digest JSON</a>
      )}
      {digestValidateUrl && (
        <a class="pill" href={digestValidateUrl} target="_blank" rel="noopener noreferrer">Digest validate</a>
      )}
    </div>
  </nav>
)}
